name: Daily Album Update

on:
  schedule:
    - cron: "30 23 * * *"
  workflow_dispatch:

jobs:
  update-album:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Read backlog and update album.json
        run: |
          BACKLOG_FILE="album-backlog.json"
          ALBUM_FILE="album.json"

          if [ ! -f "$BACKLOG_FILE" ]; then
            echo "album-backlog.json not found"
            exit 1
          fi

          NEXT_ALBUM_ID=$(jq -r '.albums[0]' "$BACKLOG_FILE")

          if [ "$NEXT_ALBUM_ID" = "null" ] || [ -z "$NEXT_ALBUM_ID" ]; then
            echo "Backlog is empty"
            exit 1
          fi

          echo "Next album ID: $NEXT_ALBUM_ID"
          echo "{ \"albumId\": \"$NEXT_ALBUM_ID\" }" > "$ALBUM_FILE"

          jq '.albums |= .[1:]' "$BACKLOG_FILE" > tmp.json
          mv tmp.json "$BACKLOG_FILE"

      - name: Commit and push changes
        run: |
          git config user.name "album-bot"
          git config user.email "album-bot@users.noreply.github.com"

          git add album.json album-backlog.json
          git commit -m "Daily album update"
          git push
